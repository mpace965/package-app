import { createReadStream } from "fs";
import csv from "csv-parser";
import { DataProviderNotFoundError } from "../DataProviderNotFoundError";
import { DataProviderInternalError } from "../DataProviderInternalError";
import { Vulnerability } from "../../entity/Vulnerability";

interface Line {
  id: string;
  packageName: string;
  packageVersion: string;
  description: string;
  timestamp: string;
}

export class VulnerabilityCSVDataProvider {
  private packageCache: Record<string, Array<Vulnerability>> = {};
  private cached: boolean = false;

  constructor(private path: string) {}

  public async read(packageName: string): Promise<Array<Vulnerability>> {
    await this.loadIfNotCached();

    const vulnerability = this.packageCache[packageName];

    if (vulnerability) {
      return vulnerability;
    }

    throw new DataProviderNotFoundError();
  }

  private async loadIfNotCached(): Promise<void> {
    if (!this.cached) {
      await this.loadData();
      this.cached = true;
    }
  }

  private async loadData(): Promise<void> {
    try {
      await new Promise<void>((resolve, reject) => {
        createReadStream(this.path)
          .pipe(
            csv([
              "id",
              "packageName",
              "packageVersion",
              "description",
              "timestamp",
            ])
          )
          .on(
            "data",
            ({
              id,
              packageName,
              packageVersion,
              description,
              timestamp,
            }: Line) => {
              if (!this.packageCache[packageName])
                this.packageCache[packageName] = [];

              this.packageCache[packageName].push({
                id,
                packageName,
                packageVersion,
                description,
                timestamp: new Date(parseInt(timestamp) * 1000),
              });
            }
          )
          .on("end", resolve)
          .on("error", reject);
      });
    } catch (e) {
      console.error(e);
      throw new DataProviderInternalError();
    }
  }
}
